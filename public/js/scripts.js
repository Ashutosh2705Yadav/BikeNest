const API_BASE = '/api';
async function fetchVehicles(){ const r = await fetch(API_BASE + '/vehicles'); return r.json(); }
async function renderHome(){ const row = document.getElementById('vehiclesRow'); if(!row) return; const vehicles = await fetchVehicles(); if(!vehicles.length){ row.innerHTML = '<div class="col-12"><div class="alert alert-info">No vehicles yet. Admin can add from dashboard.</div></div>'; return; } row.innerHTML = vehicles.map(v=>`<div class="col-md-4"><div class="card"><img src="${v.image||'https://via.placeholder.com/600x400'}" class="card-img-top"><div class="card-body"><h5 class="card-title">${v.name} <small class="text-muted">(${v.type})</small></h5><p class="card-text">Rate: ₹${v.rate_per_hour}/hr</p><p class="card-text">${v.available?'<span class="badge bg-success">Available</span>':'<span class="badge bg-danger">Not available</span>'}</p><a href="/booking.html?vehicleId=${v.id}" class="btn btn-primary">Book</a></div></div></div>`).join(''); }
function getQueryParam(name){ const url = new URL(window.location.href); return url.searchParams.get(name); }
async function renderBooking(){ const vid = getQueryParam('vehicleId'); const details = document.getElementById('vehicleDetails'); const form = document.getElementById('bookingForm'); if(!vid||!details||!form) return; const vehicles = await fetchVehicles(); const v = vehicles.find(x=>x.id===vid); if(!v){ details.innerHTML = '<div class="alert alert-danger">Vehicle not found</div>'; return; } details.innerHTML = `<h3>${v.name} (${v.type})</h3><p>Rate: ₹${v.rate_per_hour}/hr</p>`; form.onsubmit = async (e)=>{ e.preventDefault(); const payload = { vehicleId: v.id, renterName: document.getElementById('name').value, renterPhone: document.getElementById('phone').value, durationHours: document.getElementById('duration').value, paymentMode: document.getElementById('paymentMode').value }; const res = await fetch(API_BASE + '/bookings', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); if(res.ok){ alert('Booking created'); window.location='/'; } else { const err = await res.json(); alert('Booking failed: '+(err.message||res.status)); } }; }
async function adminLogin(){ const form = document.getElementById('adminLoginForm'); if(!form) return; form.onsubmit = async (e)=>{ e.preventDefault(); const username = document.getElementById('username').value; const password = document.getElementById('password').value; const res = await fetch(API_BASE + '/admin/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password }) }); if(res.ok){ const data = await res.json(); localStorage.setItem('bikenest_token', data.token); window.location = '/admin-dashboard.html'; } else alert('Invalid credentials'); }; }
async function adminDashboard(){ const token = localStorage.getItem('bikenest_token'); if(!token){ window.location = '/admin-login.html'; return; } const addForm = document.getElementById('addVehicleForm'); const bookingsList = document.getElementById('bookingsList'); addForm.onsubmit = async (e)=>{ e.preventDefault(); const v = { name: document.getElementById('vname').value, type: document.getElementById('vtype').value, ratePerHour: Number(document.getElementById('vrate').value), image: document.getElementById('vimage').value, available: true }; const res = await fetch(API_BASE + '/admin/vehicle', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(v) }); if(res.ok){ alert('Vehicle added'); location.reload(); } else { const e = await res.json(); alert('Failed to add: '+(e.message||res.status)); } }; const res = await fetch(API_BASE + '/bookings', { headers:{ 'Authorization': 'Bearer ' + token } }); if(res.ok){ const bookings = await res.json(); bookingsList.innerHTML = bookings.map(b=>`<div class="card mb-2 p-2">${b.renter_name} - ${b.vehicle_id} - ₹${b.total_cost} - ${b.status}</div>`).join(''); } else { bookingsList.innerHTML = '<div class="text-muted">No bookings or unauthorized</div>'; } }
document.addEventListener('DOMContentLoaded', ()=>{ renderHome(); renderBooking(); adminLogin(); adminDashboard(); });
